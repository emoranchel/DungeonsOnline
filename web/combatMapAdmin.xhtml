<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
  <c:set value="30" var="gridSize"/>
  <c:set value="3" var="gridPadding"/>
  <h:head>
    <title>Battle map</title>
    <link rel="stylesheet" href="res/ui-custom/css/custom-theme/jquery-ui-1.10.2.custom.css" type="text/css"/> 
    <link rel="stylesheet" href="res/css/styles.css" type="text/css"/> 
    <link rel="stylesheet" href="res/css/map.css" type="text/css"/> 
    <script src="res/js/jquery-1.9.1.js" type="text/javascript" ></script>
    <script src="res/ui-custom/js/jquery-ui-1.10.2.custom.js" type="text/javascript" ></script>
    <script src="res/js/map-admin.js" type="text/javascript" ></script>
    <script src="res/js/map-commons.js" type="text/javascript" ></script>
  </h:head>
  <h:body style="border:0; margin: 0; padding: 0">
    <h1>Combat <a href="campaignAdmin.jsf">Campaign</a></h1>
    <h2>Map <a href="combatDataAdmin.jsf">Data</a></h2>

    <div class="separatedBlock">
      <h:form class="inlineForm">
        <h:outputText value="File:"/>
        <h:inputText value="${savegame.combatFilename}"/>
        <h:commandButton value="Save" action="#{savegame.saveCombat()}"/>
      </h:form>
      <h:form class="inlineForm">
        <h:outputText value="File:"/>
        <h:inputText value="${savegame.combatFilename}"/>
        <h:commandButton value="Load" action="#{savegame.loadCombat()}"/>
      </h:form>
    </div>
    <div id="mapContainer">
      <div id="map">
        <h:panelGroup id="containerIcons">
          <ui:repeat value="${combatActions.combatants}" var="data">
            <div id="char-${data.name}" class="char" title="${data.name}" data-char="${data.name}"
                 style="background-image:url('${data.small}'); top:${(data.y * gridSize) + gridPadding}px; left:${(data.x * gridSize) + gridPadding}px; width:${(data.width * gridSize) - (gridPadding * 2)}px; height:${(data.height * gridSize) - (gridPadding * 2)}px;">
              <div class="hpBar" style="width: ${data.hpp}%; background: ${data.color};"></div>
            </div>

            <div id="char-${data.name}-options" class="options">
              <div id="char-${data.name}-tabs" class="tabs">
                <ul>
                  <li><a href="#char-${name}-tabs-main">Main</a></li>
                  <li><a href="#char-${name}-tabs-data">Data</a></li>
                </ul>
                <div id="char-${name}-tabs-main">
                  <div class="hpBar" style="width: ${data.hpp}%; background: ${data.color}; position: relative; height: 4px; margin-top:2px;"></div>
                  <h:form class="formblock">
                    <h:outputText value="Damage"/>
                    <h:inputText value="#{data.damage}" size="3"/>
                    <h:commandButton value="Damage!" action="#{combatActions.dodamage(data)}">
                      <f:ajax render=":containerIcons :formInitiatives" execute="@form" />
                    </h:commandButton>
                  </h:form>
                  <h:form class="formblock">
                    <h:outputText value="Heal"/>
                    <h:inputText value="${data.heal}" size="3"/>
                    <h:commandButton value="Heal!" action="#{combatActions.doheal(data)}">
                      <f:ajax render=":containerIcons :formInitiatives" execute="@form" />
                    </h:commandButton>
                  </h:form>
                  <h:form class="formblock">
                    <h:commandButton value="&larr;" action="#{combatActions.moveLeft(data)}">
                      <f:ajax render=":containerIcons" />
                    </h:commandButton>
                    <h:commandButton value="&uarr;" action="#{combatActions.moveUp(data)}">
                      <f:ajax render=":containerIcons" />
                    </h:commandButton>
                    <h:commandButton value="&rarr;" action="#{combatActions.moveRight(data)}">
                      <f:ajax render=":containerIcons" />
                    </h:commandButton>
                    <h:commandButton value="&darr;" action="#{combatActions.moveDown(data)}">
                      <f:ajax render=":containerIcons" />
                    </h:commandButton>
                  </h:form>
                </div>
                <div id="char-${name}-tabs-data">
                  <h:form>
                    <h:panelGrid columns="2">
                      <h:outputLabel value="Name"/>
                      <h:outputLabel value="${data.name}"/>
                      <h:outputLabel value="Type"/>
                      <h:selectOneMenu value="${data.type}">
                        <f:selectItems value="${combatActions.typeValues}"/>
                      </h:selectOneMenu>
                      <h:outputLabel value="HP"/>
                      <h:inputText value="${data.hp}" size="3"/>
                      <h:outputLabel value="HPMax"/>
                      <h:inputText value="${data.maxHp}" size="3"/>
                      <h:outputLabel value="Healing Surges"/>
                      <h:inputText value="${data.healingSurge}" size="2"/>
                      <h:outputLabel value="Initiative"/>
                      <h:inputText value="${data.initiative}" size="3"/>
                    </h:panelGrid>
                    <h:commandButton action="#{combatActions.update(data)}" value="Update">
                      <f:ajax render=":containerIcons :formInitiatives" execute="@form" />
                    </h:commandButton>
                  </h:form>
                </div>
              </div>
            </div>
          </ui:repeat>
        </h:panelGroup>
      </div>
    </div>

    <div id="map-options" class="options">
      <div class="tabs">
        <ul>
          <li><a href="#map-options-move">Move</a></li>
          <li><a href="#map-options-add">Add Char</a></li>
        </ul>
        <div id="map-options-move">
          <h:form id="formMapOptions">
            <h:inputHidden class="map-options-x" value="${combatActionParams.x}"/><h:inputHidden class="map-options-y" value="${combatActionParams.y}"/>
            <h:selectOneMenu value="${combatActionParams.target}" class="map-options-select">
              <f:selectItems value="${combatActions.charItems}"/>
            </h:selectOneMenu>
            <h:commandButton value="Move" action="#{combatActions.move()}" class="map-options-moveBtn">
              <f:ajax render=":containerIcons" execute="@form" />
            </h:commandButton>
          </h:form>
        </div>
        <div id="map-options-add">
          <h:form>
            <h:inputHidden class="map-options-x" value="${combatActionParams.x}"/><h:inputHidden class="map-options-y" value="${combatActionParams.y}"/>
            <h:panelGrid columns="2">
              <h:outputLabel value="Type"/>
              <h:selectOneMenu value="${combatActionParams.newCombatant.type}">
                <f:selectItems value="${combatActions.typeValues}"/>
              </h:selectOneMenu>
              <h:outputLabel value="Name"/>
              <h:inputText value="${combatActionParams.newCombatant.name}"/>
              <h:outputLabel value="Small"/>
              <h:inputText value="${combatActionParams.newCombatant.small}"/>
              <h:outputLabel value="Medium"/>
              <h:inputText value="${combatActionParams.newCombatant.medium}"/>
              <h:outputLabel value="HP"/>
              <h:inputText value="${combatActionParams.newCombatant.hp}" size="3"/>
              <h:outputLabel value="HPMax"/>
              <h:inputText value="${combatActionParams.newCombatant.maxHp}" size="3"/>
              <h:outputLabel value="Healing Surges"/>
              <h:inputText value="${combatActionParams.newCombatant.healingSurge}" size="2"/>
              <h:outputLabel value="Initiative"/>
              <h:inputText value="${combatActionParams.newCombatant.initiative}" size="3"/>
              <h:outputLabel value="Width"/>
              <h:inputText value="${combatActionParams.newCombatant.width}" size="2"/>
              <h:outputLabel value="Height"/>
              <h:inputText value="${combatActionParams.newCombatant.height}" size="2"/>
              <h:commandButton value="Add" action="#{combatActions.createFromMap}">
                <f:ajax render=":containerIcons :formInitiatives" execute="@form" />
              </h:commandButton>
            </h:panelGrid>
          </h:form>
        </div>
      </div>
    </div>

    <a onclick="showInitiative();" id="showInitiative">[Open Initiative]</a>
    <a onclick="showCombatLog();" id="showCombatLog">[Open Combat Log]</a>
    <div id="initiative">
      <a onclick="hideInitiative();">[close]</a>
      <div id="initiativeContent">
        <h:form id="formInitiatives">
          <h:commandButton value="Next" action="#{combatActions.nextInitiative()}">
            <f:ajax render=":formInitiatives"/>
          </h:commandButton>
          <h:panelGroup>
            <ui:repeat value="${combatActions.initiatives}" var="data">
              <div style="background-image:url('${data.medium}')" class="initiativePortrait" data-char="${data.name}" id="char-${data.name}-init">
                <div style="width: ${data.hpp}%; background-color: ${data.color};" class="initiativeHpBar"></div>
                <div class="initiativeName">${data.name}</div>
                <div class="initiativeNumber">${data.initiative}<br/>${data.hp}/${data.maxHp}</div>
              </div>
            </ui:repeat>
          </h:panelGroup>
        </h:form>
      </div>
    </div>
    <div id="combatLog">
      <a onclick="hideCombatLog();">[close]</a>
      <div id="combatLogContent"></div>
    </div>
    <script type="text/javascript">
      var rebindAjax = function rebindAjax(data) {
        if (data.status === "success") {
          rebind();
        }
      };
      jsf.ajax.addOnEvent(rebindAjax);
    </script>
  </h:body>
</html>

