<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
  <c:set var="title" value="Battle Data"/>
  <ui:composition template="/WEB-INF/templates/admin-template.xhtml">
    <ui:define name="navigation">
      <ul>
        <li>Campaign | <h:link outcome="/admin/combat/data" value="Battle"/>
          <ul>
            <li><h:link outcome="/admin/campaign/characters" value="Characters"/></li>
            <li>Powers</li>
            <li>Equipment</li>
            <li>Data</li>
          </ul>
        </li>
      </ul>
    </ui:define>
    <ui:define name="resources">
      <script>
        $(function () {
          var newBonus = {};

          var bonusTable = $("#bonusArea").find("tbody");
          $(".characterDetail").dialog({autoOpen: false, width: "80%"});
          $("#addNewFeatureDialog").dialog({autoOpen: false, width: "60%"});

          $(".nameLink").on("click", function () {
            var charId = $(this).html();
            $("#" + charId).dialog("open");
            $("#" + charId).find(".addNewFeatureButton").button().on("click", function () {
              $("#addNewFeatureDialog").dialog("option", "title", "Add feature to: " + charId);
              $("#addNewFeatureDialog").dialog("open");
              $(".addNewFeatureCharacter").val(charId);
              bonusTable.empty();
              newBonus = {};
              $(".addNewFeatureBonus").val(JSON.stringify(newBonus));
            });
          });

          $(".bonusLink").on("click", function () {
            var bonusName = $(this).data("bonus");
            if (newBonus.hasOwnProperty(bonusName)) {
              return;
            }

            var row = $("<tr/>");
            var nameCell = $("<td/>");
            var deleteLink = $("<a/>");
            deleteLink.attr("href", "#");
            deleteLink.html("[X]");
            deleteLink.on("click", function () {
              row.remove();
              delete newBonus[bonusName];
              $(".addNewFeatureBonus").val(JSON.stringify(newBonus));
            });
            nameCell.append(deleteLink);
            nameCell.append($(this).html());
            row.append(nameCell);
            var cell = $("<td/>");
            var input = $("<input/>");
            input.attr("type", "text");
            input.attr("size", "2");
            input.on("change", function () {
              newBonus[bonusName] = input.val();
              $(".addNewFeatureBonus").val(JSON.stringify(newBonus));
            });
            input.val("0");
            cell.append(input);
            row.append(cell);
            bonusTable.append(row);
            input.trigger("change");
          });

          $("#hiddenElements").hide();
        });
      </script>
      <script>
        $(function () {
          $(".tooltip").each(function () {
            var tooltipDiv = $(this);
            //tooltipDiv.parent().tooltip();
            tooltipDiv.parent().tooltip({content: function () {
                return tooltipDiv.html();
              }});
            tooltipDiv.hide();
          });
        });
      </script>
    </ui:define>
    <ui:define name="content">
      <h:form>
        <h1>Ability Scores</h1>
        <h2>Characters</h2>
        <h:commandButton action="${adminCampaign.saveAll}" value="Save All"/>
        <h:dataTable value="${adminCampaign.characters}" var="cha">
          <h:column>
            <f:facet name="header">Name</f:facet><a class="nameLink" href="#">${cha.name}</a>
          </h:column>
          <h:column>
            <f:facet name="header">Class</f:facet>${cha.charClass.name}
          </h:column>
          <h:column>
            <f:facet name="header">Type</f:facet>
            <h:selectOneMenu value="${cha.ctype}">
              <f:selectItems value="${adminCampaign.types}"></f:selectItems>
            </h:selectOneMenu>
          </h:column>
          <h:column>
            <f:facet name="header">LVL</f:facet><h:inputText value="${cha.lvl}" size="2"/>
          </h:column>
          <h:column>
            <f:facet name="header">STR</f:facet><h:inputText value="${cha.strength}" size="2"/>
          </h:column>
          <h:column>
            <f:facet name="header">CON</f:facet><h:inputText value="${cha.constitution}" size="2"/>
          </h:column>
          <h:column>
            <f:facet name="header">DEX</f:facet><h:inputText value="${cha.dexterity}" size="2"/>
          </h:column>
          <h:column>
            <f:facet name="header">INT</f:facet><h:inputText value="${cha.intelligence}" size="2"/>
          </h:column>
          <h:column>
            <f:facet name="header">WIS</f:facet><h:inputText value="${cha.wisdom}" size="2"/>
          </h:column>
          <h:column>
            <f:facet name="header">CHA</f:facet><h:inputText value="${cha.charisma}" size="2"/>
          </h:column>
        </h:dataTable>
        <h:commandButton action="${adminCampaign.saveAll}" value="Save All"/>
      </h:form>

      <br style="clear: both;"/>

      <c:forEach items="${adminCampaign.characters}" var="cha">
        <div id="${cha.name}" class="characterDetail" title="${cha.name}">
          <h:form>
            <div style="float: left;">
              <h4>Scores</h4>
              <table>
                <tr><td>LVL</td><td><h:inputText value="${cha.lvl}" size="2"/></td></tr>
                <tr><td>Type</td><td>
                    <h:selectOneMenu value="${cha.ctype}">
                      <f:selectItems value="${adminCampaign.types}"></f:selectItems>
                    </h:selectOneMenu>
                  </td></tr>
                <tr><td>STR</td><td><h:inputText value="${cha.strength}" size="2"/></td></tr>
                <tr><td>CON</td><td><h:inputText value="${cha.constitution}" size="2"/></td></tr>
                <tr><td>DEX</td><td><h:inputText value="${cha.dexterity}" size="2"/></td></tr>
                <tr><td>INT</td><td><h:inputText value="${cha.intelligence}" size="2"/></td></tr>
                <tr><td>WIS</td><td><h:inputText value="${cha.wisdom}" size="2"/></td></tr>
                <tr><td>CHA</td><td><h:inputText value="${cha.charisma}" size="2"/></td></tr>
              </table>
            </div>
            <div style="float: left;">
              <h4>Skills</h4>
              <h:dataTable value="${cha.skills}" var="skill">
                <h:column><f:facet name="header">Name</f:facet>${skill.id.skill}</h:column>
                <h:column><f:facet name="header">Ability</f:facet>${skill.ability}</h:column>
              </h:dataTable>
            </div>
            <div style="float: left;">
              <h4>Features</h4>
              <c:forEach items="${cha.bonuses}" var="feature">
                <span title="">[${feature.lvl}] ${feature.name}<div class="tooltip">
                    <h4>${feature.name}</h4>
                    ${feature.description}
                    <table>
                      <c:forEach items="${adminCampaign.displayBonus(feature)}" var="bonus">
                        <tr><td>${bonus.stat}</td><td>${bonus.value}</td></tr>
                      </c:forEach>
                    </table>
                  </div></span>
                <h:commandButton value="X" action="${adminCampaign.removeFeat(cha, feature)}"/>
                <br/>
              </c:forEach>
              <input type="button" value="ADD NEW" class="addNewFeatureButton"/>  
            </div>
            <div style="clear: both;">
              <h:commandButton value="SAVE" action="${adminCampaign.save(cha)}"/>
            </div>
          </h:form>
        </div>
      </c:forEach>
      <div id="addNewFeatureDialog">
        <h:form>
          <div style="float:left">
            <h:inputText value="${adminCampaign.newfeature.name}" size="20"/><br/>
            Description:<br/><h:inputTextarea value="${adminCampaign.newfeature.description}" rows="3" cols="20"/><br/>
            <table id="bonusArea">
              <thead>
                <tr>
                  <th>Property</th><th>Bonus</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
          <div style="float:left">
            <ul style="margin:0">
              <li><a href="#" class="bonusLink" data-bonus="STR">Strength</a></li>
              <li><a href="#" class="bonusLink" data-bonus="HP">HP</a></li>
              <li><a href="#" class="bonusLink" data-bonus="SKILL:Acrobatics">Skill:Acrobatics</a></li>
            </ul>
          </div>

          <div style="clear:both">
            <h:commandButton value="Save" action="${adminCampaign.addFeature()}"/>
            <div id="hiddenElements">
              <h:inputText value="${adminCampaign.newfeature.chara}" class="addNewFeatureCharacter"/>
              <h:inputText value="${adminCampaign.newfeature.bonus}" class="addNewFeatureBonus"/>
            </div>
          </div>
        </h:form>
      </div>
    </ui:define>
  </ui:composition>
</html>

